name: release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    release:
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: checkout
              uses: actions/checkout@v4

            - name: create release
              if: startsWith(github.ref, 'refs/tags/')
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  TAG_NAME=${GITHUB_REF#refs/tags/}
                  gh release create "$TAG_NAME" \
                    --repo="$GITHUB_REPOSITORY" \
                    --title="$TAG_NAME" \
                    --generate-notes || echo "skipped"

    publish:
        needs: release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write

        steps:
            - name: checkout
              uses: actions/checkout@v4

            - name: setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: install dependencies
              run: bun install --frozen-lockfile

            - name: build package
              run: bun run build

            - name: setup Node.js for publish
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  registry-url: "https://registry.npmjs.org"
                  scope: "@rel-packages"

            - name: check npm token
              env:
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  if [ -z "$NPM_TOKEN" ]; then
                    echo "NPM_TOKEN is empty..."
                    exit 1
                  fi

            - name: publish to npm
              run: npm publish --provenance --access public
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
